

## Background

<!--
Provide context for type of problem to be solved, why its an interesting question, and why joint models are useful to solve them; give enough info to gain interest, but don't give away whole story

introduce clinical example (treatment efficacy vs. safety) early and reference back to it throughout

basic problem should be stated as clearly as possible - to answer questions about multiple outcomes, you need models that account for the dependence between outcomes

need to add more after clinical paper review, esp. Costa et al and dose-finding example
-->

Randomized clinical trials are considered the gold standard for evaluating a medical intervention and often involve multiple endpoints or outcomes [cite]. For example, in early phase trials interest may lie in the effect of dose on both efficacy and toxicity endpoints simultaneously. Similarly, later phase confirmatory trials may seek to quantify the risk-benefit tradeoffs of a potential treatment. Further, many studies are designed to measure the effects of the intervention on a group of several co-primary outcomes representing different dimensions of the underlying disease @evans_fundamental_2016, and most trials collect data on multiple types of adverse events. For longitudinal or repeated measures data, measurements of a single outcome variable for a trial participant at different times can be considered to be multiple outcomes. 

In the same way, data from multiple constituent elements of a body system, such as bilateral eye data, ear data, or (bilateral limb function data? something related to studies Dr. Self or Archer have done)

A cluster randomized trial collects data from participants in groups that share a common characteristic such as study center or familial relationship  [@wu_gaussian_2014]

Trials collecting both surrogate and true endpoints offer yet another example [for example molenberghs et al 2001 ref]

The distinguishing trait in of all these situation is that multiple outcomes are observed within each individual or sampling unit and this clustering induces a dependence between the separate outcome measures.


properly accounting for this dependence is a main motivation for joint models

In these situations it is common to perform a separate analysis for each of the outcomes, but modeling the multiple outcomes together in a single joint model has several advantages. First, a joint model allows the investigator to answer specific questions involving combinations of outcomes, e.g. "What is the posterior probability that either the intervention has a specified level of effectiveness *or* the risk of adverse events is low?" or "Is the intervention efficacious for three co-primary endpoints simultaneously?" These questions can only be correctly answered by incorporating the dependence between the outcomes.

3 separate analyses could answer "does drug improve symptom A?", "does drug improve symptom B?", and "does drug improve symptom C?" but not "does drug improve all 3 symptoms for a participant?"

?? probability the rate of safety event 1 is less than the rate of safety event 2

In addition to allowing the investigator to answer questions regarding the outcomes, the dependence may be of interest in its own right. A benefit-risk analysis asks the question "How strong is the relationship between the efficacy outcome and the safety outcome?" Comparing two drugs with identical efficacy and safety on average, the one with a weaker relationship between efficacy and safety will be preferred. 


Understanding the relationship between outcomes provides a more complete picture of how the intervention works in multiple dimensions. 

<!-- check this
Joint modeling can also avoid issues related to multiple testing since they lead to the use of simultaneous tests of joint model parameters rather than separate individual tests.

De Leon describes increased power and better control of Type I error by using [find ref cited at beginning of @de_leon_copula-based_2011] .
-->

<!-- scratch
P(Y_1>0,Y_2>0)
P(A and B)
P(A or B) = P(A) + P(B) - P(A and B)

It also provides a better characterization of the relationship between outcomes and how this relationship is modified by the intervention. 

and interest may lie in the how the intervention simultaneously affects all these outcomes.
There are also situations where multiple efficacy or safety events 
These trials are often designed to determine the effect of the intervention on a single primary endpoint.

Principle of beneficence means that benefits must outweigh the risks implying that all interventions must be evaluated for both efficacy and safety. Often the effect of treatment on efficacy and safety outcomes are explored with separate models for each type of outcome.

Interplay between benefit and risk captured in dependence of variable measuring these

quantify tradeoff between outcomes and answer questions involving combinations, i.e. probability that intervention is effective and risk of adverse events is low 

[Other applications - surrogate variable analysis]

Rather than making a binary yes/no decision on whether a new treatment is effective, modeling multivariate outcomes allows the investigator to quantify efficacy along a gradient. i.e. what benefit can be achieved with a low, medium, or high risk of adverse event. What dose level provides the best balance of efficacy and toxicity

applications at multiple phases - phase I/II dosing toxicity/efficacy, phase III benefit-risk, phase IV? adverse risk assessment]
-->

## Copulas for Joint Modeling

<!--
Introduction to the copula approach to joint modeling
-->

Several strategies have been proposed for such joint models including classical multivariate regression, factorization models and frailty/random effects models [@teixeira-pinto_correlated_2009, other citations]. In this report I will focus on use of copulas for joint models.

A copula (denoted $C$) is a distribution function that 'couples' separate univariate distributions together to create a single joint, multivariate distribution. A $d$-dimensional copula combines $d$ univariate distributions where $d$ is the number of univariate distributions to be combined. The result is another $d$-dimensional multivariate distribution (denoted $H$). A foundational 1959 article published by mathematician Abe Sklar [@sklar_fonctions_1959] gives the equation that relates the univariate distributions, $C$, and $H$. It also guarantees that if the univariate distributions are continuous $H$ is *unique*. The same theorem implies the converse; given $d$ univariate distributions and $H$ the equation can be used to construct a unique $C$.

As a motivating example, consider two univariate continuous random variables $Y_1 \sim \text{Normal}(0,1)$ and $Y_2 \sim \text{Gamma}(4,1)$ representing efficacy response and adverse event rate, respectively. Figure \@ref(fig:ex1-a) shows the bivariate $H$ distribution constructed using the distributions of $Y_1$ and $Y_2$ and a Gumbel copula $C(u,v)=\exp[-((-\log u)^\theta +(-\log v)^\theta)^{1/\theta}]$ with $\theta=1\frac{1}{3}$. The individual univariate distributions are shown along the top and right margins while the main contour plot shows the bivariate distribution. The subplot in the upper right has $n=500$ draws from the bivariate distribution. Contrast this with figure \@ref(fig:ex1-b) which is constructed using the identical margins with a Clayton copula $C(u,v)=\max\{u^{-\theta} + v^{-\theta}-1,0\}^{-1/\theta}$ with $\theta=\frac{2}{3}$. The values of the copula parameter $\theta$ were chosen to correspond to Kendall's $\tau=0.25$ for both distributions. These plots verify that the same margins can produce different dependence patterns and the dependence information is contained in the selected copula. Intuitively, this means the interpretation of the margins is the same regardless of the dependence structure. An analysis which only considered each outcome separately under would yield identical results under either scenario. For example, $Pr(\text{efficacy}>0)=0.5$ for both. The probability of the combined event "$\text{efficacy}>1$ and $\text{AE rate}>4$" is 0.112 for the distribution constructed using the Gumbel copula and 0.094 for the distribution constructed using the Clayton copula.

```{r ex1-a, fig.cap='Contour plot of multivariate density with standard Normal and Gamma(4,1) margins combined using a Gumbel copula with $\\theta=1\\frac{1}{3}$. The small scatterplot in the top right of each shows n=500 random draws from the multivariate density', fig.show = 'hold', fig.align='center', out.width='90%'}
## Example 1a

# set Kendall's tau
tau <- 0.25

# define Gumbel copula
gc <- gumbelCopula( iTau(gumbelCopula(),tau) )

# define marginal distributions
marg <- c("norm", "gamma")
marg_params <- list(list(mean=0, sd = 1), list(shape=4, rate = 1))

# multivariate distribution combining margins and copula
mvd_gc <- mvdc(copula = gc, margins = marg, paramMargins = marg_params)

# plotting parameters
color2 <- rev(rainbow(11, start = 0/6, end = 4/6))
xl <- c(-4,4)
yl <- c(-0.5,8.5)

# Gumbel copula
op<-par(fig=c(0,0.75,0,0.75))
contour(mvd_gc, dMvdc, xlim=xl, ylim=yl, 
      xlab=bquote(Y[1]~~(Normal)), ylab=bquote(Y[2]~~('Gamma')),
      col=color2, bty="n")

par(fig=c(0,0.75,0.45,1), new=TRUE)
curve(dnorm,xl[1],xl[2],xlab="",ylab="", xlim=xl, bty="n")

par(fig=c(0.6,0.9,0,0.75),new=TRUE)
x_seq<-seq(0,yl[2],length=100)
y_seq<-sapply(x_seq, function(x) dgamma(x,marg_params[[2]]$shape,marg_params[[2]]$rate))
plot(y_seq,x_seq, type="l",xlab="",ylab="",ylim=yl, bty="n")

par(fig=c(0.6,0.9,0.45,1),new=TRUE)
plot(rMvdc(500, mvd_gc), xlim=xl, ylim=yl, xlab="",ylab="", bty="n",
     pch='.', col=rgb(0,0,0,0.6))

#mtext("Gumbel", side=3, outer=TRUE, line=-3.5) 

# probability of joint event
#P(y1>1,y2>4) = 1- P(y1<1,y2<inf) - P(y1<inf,y2<4) + P(y1<1,y2<4)
#1 - pMvdc(c(1, 1000),mvd_gc) - pMvdc(c(1000, 4),mvd_gc) + pMvdc(c(1, 4),mvd_gc)
```

```{r, eval=knitr::is_html_output(), fig.cap='Interactive plot for Figure \\@ref(fig:ex1-a)'}
library(rgl)
y1<-seq(xl[1]-1,xl[2]+1,length=75)
y2<-seq(yl[1]-1,yl[2]+1,length=75)
gc_z<-outer(y1,y2,FUN=function(a,b) dMvdc(matrix(c(a,b),nrow=75^2),mvd_gc))

# color scheme
num_col<-100
color <- rev(rainbow(num_col, start = 0/6, end = 4/6))

gc_zcol <- cut(gc_z, num_col)

plotid1<-persp3d(y1,y2,gc_z, col=color[gc_zcol],
                 xlab="Normal", ylab="Gamma", zlab="")

fn<-spin3d(axis = c(0, 0, 1), rpm = 6) # spin function

rglwidget(elementId = "plot3d_mvd_gc") %>% 
  playwidget(par3dinterpControl(fn, 0, 10, steps=25),
       step = 0.1, loop = TRUE, rate = 0.75,
       components=c("Play","Slower","Faster","Reset","Slider"))

```

```{r ex1-b, fig.cap='Contour plots of multivariate density with standard Normal and Gamma(4,1) margins combined using a Clayton copula with $\\theta=\\frac{2}{3}$. The small scatterplot in the top right of each shows n=500 random draws from the multivariate density', fig.show = 'hold', fig.align='center', out.width='90%'}
## Example 1b

# define Clayton copula
cc <- claytonCopula( iTau(claytonCopula(),tau) )

# multivariate distribution combining margins and copula
mvd_cc <- mvdc(copula = cc, margins = marg, paramMargins = marg_params)

# Clayton copula
par(fig=c(0,0.75,0,0.75))
contour(mvd_cc, dMvdc, xlim=xl, ylim=yl, 
      xlab=bquote(Y[1]~~(Normal)), ylab=bquote(Y[2]~~('Gamma')),
      col=color2, bty="n")

par(fig=c(0,0.75,0.45,1), new=TRUE)
curve(dnorm,xl[1],xl[2],xlab="",ylab="", xlim=xl, bty="n")

par(fig=c(0.6,0.9,0,0.75),new=TRUE)
x_seq<-seq(0,yl[2],length=100)
y_seq<-sapply(x_seq, function(x) dgamma(x,marg_params[[2]]$shape,marg_params[[2]]$rate))
plot(y_seq,x_seq, type="l",xlab="",ylab="",ylim=yl, bty="n")

par(fig=c(0.6,0.9,0.45,1),new=TRUE)
plot(rMvdc(500, mvd_cc), xlim=xl, ylim=yl, xlab="",ylab="", bty="n",
     pch='.', col=rgb(0,0,0,0.6))

#mtext("Clayton", side=3, outer=TRUE, line=-3.5) 

# probability of joint event
#P(y1>1,y2>4) = 1- P(y1<1,y2<inf) - P(y1<inf,y2<4) + P(y1<1,y2<4)
#1 - pMvdc(c(1, 1000),mvd_cc) - pMvdc(c(1000, 4),mvd_cc) + pMvdc(c(1, 4),mvd_cc)

```

```{r, eval=knitr::is_html_output(), fig.cap='Interactive plot for Figure \\@ref(fig:ex1-b)'}
cc_z<-outer(y1,y2,FUN=function(a,b) dMvdc(matrix(c(a,b),nrow=75^2),mvd_cc))

cc_zcol <- cut(cc_z, num_col)

plotid2<-persp3d(y1,y2,cc_z, col=color[cc_zcol],
                 xlab="Normal", ylab="Gamma", zlab="")

fn<-spin3d(axis = c(0, 0, 1), rpm = 6) # spin function

rglwidget(elementId = "plot3d_mvd_cc") %>% 
  playwidget(par3dinterpControl(fn, 0, 10, steps=25),
       step = 0.1, loop = TRUE, rate = 0.75,
       components=c("Play","Slower","Faster","Reset","Slider"))

```

```{r, eval=FALSE, fig.cap='wireframe', fig.show = 'hold', fig.align='center', out.width='48%'}

par(op)
wireframe2(mvd_gc, dMvdc, n.grid=40, xlim=xl, ylim=yl, 
      xlab="Normal", ylab="Gamma", zlab="", zoom=0.8)

wireframe2(mvd_cc, dMvdc, n.grid=40, xlim=xl, ylim=yl, 
      xlab="Normal", ylab="Gamma", zlab="", zoom=0.8)

#      par.settings = list(box.3d = list(col=c(1,2,3,4,5,6,7,8,9),
#                                        lty=c(1,1,2,2,1,2,1,1,1) )) 
```

A distinct benefit of the copula approach is this ability to separate the specification of the marginal univariate models from the specification of the copula model, which contains information about the dependence between the outcomes. This modular approach to specifying the joint model provides increased flexibility by first choosing models well suited for each outcome and then plugging these margins into a copula model that has the desired dependence structure.


<!--
Y_{tox}=\beta_{tox0} + \beta_{tox1} X_{dose} \quad Y_{eff}=\beta_{eff0} + \beta_{eff1} X_{dose}

A univariate regression model is used to explain the relationship between a single outcome and treatment. 2 outcomes = 2 separate univariate regression models 

[After explaining idea, try adding 'in other words ...' to get different take]
-->

<!--
Can include an external picture as seen in figure \@ref(fig:fig1). it's a placeholder for now

```{r fig1, fig.cap="Some Figure", fig.align='center', out.width='50%'}
knitr::include_graphics(file.path(wd,"fig","placeholder.jpg"))
```
-->

### Other joint modeling approaches

<!--
Contrast to other joint modelling approaches pointing out similarities, equivalences, differences

See section 1.6 in Joe textbook
-->

In addition to copulas, many other approaches to joint modeling have been proposed

<!--
for refs check @teixeira-pinto_correlated_2009 and @de_leon_copula-based_2011
need more refs in general bivariate data (not mixed outcomes)

sort in historical order and structure chronologically from most assumptions/restrictions to increasing relaxation, describing limitations with each model

The oldest methods for exploring are multivariate Normal which was studied by

In [Year], factorized models

Random effects or frailty models

Liang and Zeger introduced the GEE approach
-->

* Multivariate regression - multivariate Normal, multivariate student-t



* Factorized models - for outcomes $Y_1$ and $Y_2$ model $P(Y_1|Y_2)P(Y_2)$ or $P(Y_2|Y_1)P(Y_1)$

[@catalano_bivariate_1992; @cox_response_1992; @molenberghs_evaluation_2001; @olkin_multivariate_1961]


* Random effects/Frailty

--> bivariate Survival Models induced by frailties [@oakes_bivariate_1989]

* GEE/quasi likelihood  add original GEE paper??

[@liang_longitudinal_1986]

[@fitzmaurice_regression_1995] - uses location model and GEE model 



For many other multivariate approaches the joint model or dependence structure determines the form of the univariate margins as well. Limitations in available number of parametric multivariate distributions and dependence that can be modeled with them.

Copulas can be considered generalizations or extensions of several of these approaches. 

A copula-based formulation of multivariate normal and multivariate Student-$t$ regression can be produced by specifying the appropriate marginal and copula models, so these models can be seen as a special case of joint copula models.

Similarly frailty models have a copula model representation

## Applications

<!--
Introduce specific examples in clinical trials where copula models are used
-->

While there is an extensive literature on copula modeling in fields such as [], their use in clinical trials has been relatively limited compared to other joint modeling approaches described in the previous section.

### Dose-finding

Several dose-finding models using copulas to model toxicity and efficacy have been developed. We will consider [1-3?] such designs

### Risk-benefit

Costa et al. [@costa_bayesian_2018] considered the use of copula models in joint risk-benefit analysis. They present results from several simulations as well as an analysis
of a trial related to new-onset type 1 diabetes. [Provide description of the study, data, outcomes] The motivating question for this study was [] 


